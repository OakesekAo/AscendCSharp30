using System;\nusing System.Collections.Generic;\nusing System.IO;\nusing System.Linq;\nusing System.Text.Json;\nusing System.Threading.Tasks;\n\nvar builder = WebApplicationBuilder.CreateBuilder(args);\n\nbuilder.Services.AddScoped<ICustomerRepository, CustomerRepository>();\nbuilder.Services.AddScoped<IWorkOrderRepository, WorkOrderRepository>();\nbuilder.Services.AddScoped<CustomerService>();\nbuilder.Services.AddScoped<WorkOrderService>();\n\nvar app = builder.Build();\napp.UseHttpsRedirection();\n\n// ========== JSON CONFIGURATION ==========\nvar jsonOptions = new JsonSerializerOptions \n{ \n    PropertyNameCaseInsensitive = true,\n    WriteIndented = true \n};\n\n// ========== EXPORT ENDPOINTS ==========\napp.MapGet(\"/export/customers\", ExportCustomersAsync)\n.WithName(\"ExportCustomers\")\n.WithOpenApi();\n\napp.MapPost(\"/import/customers\", ImportCustomersAsync)\n.WithName(\"ImportCustomers\")\n.WithOpenApi();\n\n// ========== CUSTOMER ENDPOINTS ==========\napp.MapGet(\"/customers\", GetCustomersAsync).WithName(\"GetCustomers\").WithOpenApi();\napp.MapGet(\"/customers/{id}\", GetCustomerByIdAsync).WithName(\"GetCustomerById\").WithOpenApi();\napp.MapPost(\"/customers\", CreateCustomerAsync).WithName(\"CreateCustomer\").WithOpenApi();\n\n// ========== WORK ORDER ENDPOINTS ==========\napp.MapGet(\"/workorders\", GetWorkOrdersAsync).WithName(\"GetWorkOrders\").WithOpenApi();\napp.MapGet(\"/workorders/{id}\", GetWorkOrderByIdAsync).WithName(\"GetWorkOrderById\").WithOpenApi();\napp.MapPost(\"/workorders\", CreateWorkOrderAsync).WithName(\"CreateWorkOrder\").WithOpenApi();\n\n// ========== FILTERING & SEARCH ==========\napp.MapGet(\"/workorders/search/{term}\", SearchWorkOrdersAsync).WithName(\"SearchWorkOrders\").WithOpenApi();\napp.MapGet(\"/customers/{id}/workorders\", GetCustomerWorkOrdersAsync).WithName(\"GetCustomerWorkOrders\").WithOpenApi();\n\napp.MapGet(\"/health\", HealthCheckAsync).WithName(\"Health\").WithOpenApi();\n\napp.Run();\n\n// ========== HANDLERS ==========\nasync Task<IResult> ExportCustomersAsync(CustomerService service)\n{\n    var customers = await service.ListCustomersAsync();\n    var json = JsonSerializer.Serialize(customers, jsonOptions);\n    return Results.Ok(new { data = json, exported_at = DateTime.UtcNow });\n}\n\nasync Task<IResult> ImportCustomersAsync(IFormFile file, CustomerService service)\n{\n    if (file == null || file.Length == 0)\n        return Results.BadRequest(\"No file provided\");\n    \n    try\n    {\n        using var stream = file.OpenReadStream();\n        using var reader = new StreamReader(stream);\n        var json = await reader.ReadToEndAsync();\n        \n        var customers = JsonSerializer.Deserialize<List<Customer>>(json, jsonOptions);\n        if (customers == null) return Results.BadRequest(\"Invalid JSON format\");\n        \n        foreach (var customer in customers)\n            await service.CreateCustomerAsync(customer);\n        \n        return Results.Ok(new { imported = customers.Count });\n    }\n    catch (Exception ex)\n    {\n        return Results.BadRequest(new { error = ex.Message });\n    }\n}\n\nasync Task<IResult> GetCustomersAsync(CustomerService service)\n{\n    var customers = await service.ListCustomersAsync();\n    return Results.Ok(customers.Select(c => c.ToResponse()).ToList());\n}\n\nasync Task<IResult> GetCustomerByIdAsync(int id, CustomerService service)\n{\n    var customer = await service.GetCustomerAsync(id);\n    return customer != null ? Results.Ok(customer.ToResponse()) : Results.NotFound();\n}\n\nasync Task<IResult> CreateCustomerAsync(CreateCustomerRequest request, CustomerService service)\n{\n    if (string.IsNullOrWhiteSpace(request.Name) || string.IsNullOrWhiteSpace(request.Email))\n        return Results.BadRequest(\"Name and Email required\");\n    \n    var customer = request.ToCustomer();\n    await service.CreateCustomerAsync(customer);\n    return Results.Created($\"/customers/{customer.Id}\", customer.ToResponse());\n}\n\nasync Task<IResult> GetWorkOrdersAsync(WorkOrderService service)\n{\n    var orders = await service.ListWorkOrdersAsync();\n    return Results.Ok(orders.Select(o => o.ToResponse()).ToList());\n}\n\nasync Task<IResult> GetWorkOrderByIdAsync(int id, WorkOrderService service)\n{\n    var order = await service.GetWorkOrderAsync(id);\n    return order != null ? Results.Ok(order.ToResponse()) : Results.NotFound();\n}\n\nasync Task<IResult> CreateWorkOrderAsync(CreateWorkOrderRequest request, WorkOrderService service)\n{\n    if (request.CustomerId <= 0 || string.IsNullOrWhiteSpace(request.Description))\n        return Results.BadRequest(\"CustomerId and Description required\");\n    \n    var order = request.ToWorkOrder();\n    await service.CreateWorkOrderAsync(order);\n    return Results.Created($\"/workorders/{order.Id}\", order.ToResponse());\n}\n\nasync Task<IResult> SearchWorkOrdersAsync(string term, WorkOrderService service)\n{\n    var orders = await service.SearchWorkOrdersAsync(term);\n    return Results.Ok(orders.Select(o => o.ToResponse()).ToList());\n}\n\nasync Task<IResult> GetCustomerWorkOrdersAsync(int id, CustomerService service, WorkOrderService workOrderService)\n{\n    var customer = await service.GetCustomerAsync(id);\n    if (customer == null) return Results.NotFound();\n    \n    var orders = await workOrderService.GetWorkOrdersForCustomerAsync(id);\n    return Results.Ok(orders.Select(o => o.ToResponse()).ToList());\n}\n\nasync Task<IResult> HealthCheckAsync()\n{\n    await Task.Delay(10);\n    return Results.Ok(new { status = \"ServiceHub API v0.5 - JSON & IO\", timestamp = DateTime.UtcNow });\n}\n\n// ========== INTERFACES ==========\ninterface ICustomerRepository\n{\n    Task AddCustomerAsync(Customer customer);\n    Task<Customer?> GetCustomerAsync(int id);\n    Task<List<Customer>> GetAllAsync();\n}\n\ninterface IWorkOrderRepository\n{\n    Task AddWorkOrderAsync(WorkOrder order);\n    Task<WorkOrder?> GetWorkOrderAsync(int id);\n    Task<List<WorkOrder>> GetAllAsync();\n    Task<List<WorkOrder>> GetByCustomerAsync(int customerId);\n    Task<List<WorkOrder>> SearchAsync(string term);\n}\n\n// ========== REPOSITORIES ==========\nclass CustomerRepository : ICustomerRepository\n{\n    private List<Customer> customers = new();\n    private int nextId = 1;\n    \n    public async Task AddCustomerAsync(Customer customer)\n    {\n        await Task.Delay(10);\n        customer.Id = nextId++;\n        customers.Add(customer);\n    }\n    \n    public async Task<Customer?> GetCustomerAsync(int id)\n    {\n        await Task.Delay(10);\n        return customers.FirstOrDefault(c => c.Id == id);\n    }\n    \n    public async Task<List<Customer>> GetAllAsync()\n    {\n        await Task.Delay(10);\n        return customers;\n    }\n}\n\nclass WorkOrderRepository : IWorkOrderRepository\n{\n    private List<WorkOrder> orders = new();\n    private int nextId = 1;\n    \n    public async Task AddWorkOrderAsync(WorkOrder order)\n    {\n        await Task.Delay(10);\n        order.Id = nextId++;\n        orders.Add(order);\n    }\n    \n    public async Task<WorkOrder?> GetWorkOrderAsync(int id)\n    {\n        await Task.Delay(10);\n        return orders.FirstOrDefault(o => o.Id == id);\n    }\n    \n    public async Task<List<WorkOrder>> GetAllAsync()\n    {\n        await Task.Delay(10);\n        return orders;\n    }\n    \n    public async Task<List<WorkOrder>> GetByCustomerAsync(int customerId)\n    {\n        await Task.Delay(10);\n        return orders.Where(o => o.CustomerId == customerId).ToList();\n    }\n    \n    public async Task<List<WorkOrder>> SearchAsync(string term)\n    {\n        await Task.Delay(10);\n        return orders.Where(o => o.Description.Contains(term, StringComparison.OrdinalIgnoreCase)).ToList();\n    }\n}\n\n// ========== SERVICES ==========\nclass CustomerService\n{\n    private ICustomerRepository repository;\n    public CustomerService(ICustomerRepository repo) => repository = repo;\n    \n    public async Task CreateCustomerAsync(Customer customer) => await repository.AddCustomerAsync(customer);\n    public async Task<Customer?> GetCustomerAsync(int id) => await repository.GetCustomerAsync(id);\n    public async Task<List<Customer>> ListCustomersAsync() => await repository.GetAllAsync();\n}\n\nclass WorkOrderService\n{\n    private IWorkOrderRepository repository;\n    public WorkOrderService(IWorkOrderRepository repo) => repository = repo;\n    \n    public async Task CreateWorkOrderAsync(WorkOrder order) => await repository.AddWorkOrderAsync(order);\n    public async Task<WorkOrder?> GetWorkOrderAsync(int id) => await repository.GetWorkOrderAsync(id);\n    public async Task<List<WorkOrder>> ListWorkOrdersAsync() => await repository.GetAllAsync();\n    public async Task<List<WorkOrder>> GetWorkOrdersForCustomerAsync(int customerId) => await repository.GetByCustomerAsync(customerId);\n    public async Task<List<WorkOrder>> SearchWorkOrdersAsync(string term) => await repository.SearchAsync(term);\n}\n\n// ========== DOMAIN MODELS ==========\nclass Customer\n{\n    public int Id { get; set; }\n    public string Name { get; set; } = \"\";\n    public string Email { get; set; } = \"\";\n}\n\nclass WorkOrder\n{\n    public int Id { get; set; }\n    public int CustomerId { get; set; }\n    public string Description { get; set; } = \"\";\n    public string Status { get; set; } = \"Scheduled\";\n}\n\n// ========== DTOs ==========\nrecord CreateCustomerRequest(string Name, string Email);\nrecord CustomerResponse(int Id, string Name, string Email);\nrecord CreateWorkOrderRequest(int CustomerId, string Description, string Status);\nrecord WorkOrderResponse(int Id, int CustomerId, string Description, string Status);\n\n// ========== MAPPERS ==========\nstatic class Mappers\n{\n    public static Customer ToCustomer(this CreateCustomerRequest request) => new() { Name = request.Name, Email = request.Email };\n    public static CustomerResponse ToResponse(this Customer customer) => new(customer.Id, customer.Name, customer.Email);\n    public static WorkOrder ToWorkOrder(this CreateWorkOrderRequest request) => new() { CustomerId = request.CustomerId, Description = request.Description, Status = request.Status };\n    public static WorkOrderResponse ToResponse(this WorkOrder order) => new(order.Id, order.CustomerId, order.Description, order.Status);\n}"
